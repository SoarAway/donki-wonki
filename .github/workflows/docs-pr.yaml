name: All Branches -> Main Auto-PR

on:
  push:
    branches-ignore:
      - main  # Prevent the workflow from triggering on main itself

permissions:
  contents: write
  pull-requests: write

jobs:
  pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create PR if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current branch name
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          
          # Check if a PR already exists from this branch to main
          existing=$(gh pr list --base main --head "$BRANCH_NAME" --state open --json number -q '.[0].number')
          
          if [ -n "$existing" ]; then
            echo "PR already exists for $BRANCH_NAME: #$existing"
          else
            gh pr create \
              --base main \
              --head "$BRANCH_NAME" \
              --title "Auto PR: $BRANCH_NAME to main" \
              --body "Automated PR created for branch $BRANCH_NAME."
          fi

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          pr=$(gh pr list --base main --head "$BRANCH_NAME" --state open --json number -q '.[0].number')
          
          echo "Enabling auto-merge on PR #$pr"
          # This sets the 'auto-merge' flag. 
          # It will only actually merge if your 'Guard main' workflow passes.
          gh pr merge "$pr" --auto --squash