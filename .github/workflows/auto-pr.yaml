name: Auto PR Creation

on:
  push:
    branches:
      - docs
      - server
      - app

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current branch name from GitHub context
          BRANCH_NAME=${{ github.ref_name }}
          echo "Current branch: $BRANCH_NAME"

          # Check if PR already exists
          existing=$(gh pr list --base main --head "$BRANCH_NAME" --state open --json number -q '.[0].number')
          
          if [ -z "$existing" ]; then
            echo "Creating PR for branch $BRANCH_NAME..."
            pr_url=$(gh pr create \
              --base main \
              --head "$BRANCH_NAME" \
              --title "Auto-PR: Merge $BRANCH_NAME to main" \
              --body "Automated PR created for changes on branch $BRANCH_NAME.")
            
            echo "PR Created Successfully! Link: $pr_url"
            # Explicitly print to summary for easy access
            echo "::notice title=PR Created::PR Link: $pr_url"
          else
            echo "PR already exists for branch $BRANCH_NAME. PR #$existing"
            echo "::notice title=PR Exists::PR #$existing already exists."
          fi

          sleep 10
          
          # Enable auto-merge ONLY for docs branch (others must pass Guard manually)
          if [ "$BRANCH_NAME" == "docs" ]; then
            gh pr merge $BRANCH_NAME --auto --merge
            echo "Auto-merge enabled for docs branch"
          else
            echo "Auto-merge NOT enabled. PR requires manual approval after guard checks."
          fi